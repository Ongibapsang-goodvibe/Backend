{% load static %}
<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<title>ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;margin:24px}
  .wrap{max-width:560px;margin:0 auto}
  .row{display:flex;gap:8px;align-items:center;margin:12px 0}
  button{padding:12px 16px;font-size:16px;cursor:pointer}
  .box{border:1px solid #ddd;border-radius:12px;padding:12px;min-height:48px}
  .muted{color:#666;font-size:12px}
</style>

<div class="wrap">
  <h2>ğŸ¤ ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰</h2>
  <div class="row">
    <button id="startBtn">ëˆŒëŸ¬ì„œ ë§í•˜ê¸°</button>
    <button id="stopBtn">ë©ˆì¶”ê¸°</button>
    <span id="status" class="muted">ëŒ€ê¸° ì¤‘</span>
  </div>

  <div id="transcript" class="box" aria-live="polite">ì•„ì§ ì—†ìŒ</div>

  <div class="row" style="margin-top:16px">
    <a href="{% url 'restaurants:search-landing' %}">â† ê²€ìƒ‰ ë°©ë²• ì„ íƒìœ¼ë¡œ</a>
  </div>
</div>

<script>
(function(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const $ = (id)=>document.getElementById(id);
  const startBtn=$('startBtn'), stopBtn=$('stopBtn'), statusEl=$('status'), transcriptEl=$('transcript');

  if(!SR){
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)');
    startBtn.disabled = true; stopBtn.disabled = true; return;
  }

  const r = new SR();
  r.lang = 'ko-KR';
  r.interimResults = true;   // ë§í•˜ëŠ” ë™ì•ˆ ì¤‘ê°„ í…ìŠ¤íŠ¸ í‘œì‹œ
  r.continuous = false;      // í•œ ë²ˆ ë“£ê³  ì¢…ë£Œ
  r.maxAlternatives = 1;

  let stopper = null;
  let finalText = '';

  function setStatus(t){ statusEl.textContent = t; }

  r.onstart = () => {
    finalText = '';
    transcriptEl.textContent = 'ì¸ì‹ ì¤‘â€¦';
    setStatus('ë…¹ìŒ ì¤‘');
    clearTimeout(stopper);
    stopper = setTimeout(()=>r.stop(), 6000); // ìµœëŒ€ 6ì´ˆë§Œ ë“£ê¸°(ì›í•˜ë©´ ì¡°ì •)
  };

  r.onerror = (e) => {
    setStatus('ì˜¤ë¥˜');
    transcriptEl.textContent = 'ì¸ì‹ ì˜¤ë¥˜: ' + (e.error || 'unknown');
    console.error(e);
  };

  r.onend = () => {
    setStatus('ëŒ€ê¸° ì¤‘');
    clearTimeout(stopper);
  };

  r.onresult = (evt) => {
    let interim = '';
    for (let i=evt.resultIndex; i<evt.results.length; i++){
      const t = evt.results[i][0].transcript;
      if (evt.results[i].isFinal) finalText += t;
      else interim += t;
    }
    const shown = (finalText || interim).trim();
    transcriptEl.textContent = shown || 'ì¸ì‹ ì‹¤íŒ¨';

    // ğŸ”´ ìµœì¢… ë¬¸ì¥ì´ í™•ì •ë˜ë©´, íƒ€ì ê²€ìƒ‰ê³¼ ì™„ì „íˆ ê°™ì€ ë¡œì§ìœ¼ë¡œ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
    if (finalText.trim()){
      const q = encodeURIComponent(finalText.trim());
      // ê²°ê³¼ í˜ì´ì§€ â†’ OrderResultsPage â†’ simple_three_way_search (ê³µí†µ ë¡œì§)
      location.href = "{% url 'restaurants:order-results' %}?q=" + q + "&source=voice";
    }
  };

  startBtn.onclick = ()=> r.start();
  stopBtn.onclick  = ()=> r.stop();
})();
</script>
</html>
