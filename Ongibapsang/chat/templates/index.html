<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>밥친구</title>
</head>
<body>
    <h1>밥친구</h1>
    <button id="sendBtn">버튼을 눌러 말씀해주세요</button>
    <button id="endBtn">종료</button>
    
    <p id="answer"></p>
    <audio id="responseAudio" controls></audio>

    <script>
    const sendBtn = document.getElementById('sendBtn');
    const endBtn = document.getElementById('endBtn');
    const answerEl = document.getElementById('answer');
    const responseAudio = document.getElementById('responseAudio');

    let mediaRecorder;
    let audioChunks = [];
    let autoRecord = true; //AI 답변 끝나면 자동 녹음
    let autoStopTimer = null; //자동 종료
    let currentStream = null;

    async function startRecording() {
        if (!autoRecord) return;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = e => {
                audioChunks.push(e.data);
            };

            mediaRecorder.onstop = async () => {
                if (autoStopTimer) {
                clearTimeout(autoStopTimer);
                autoStopTimer = null;
                }

                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                audioChunks = [];

                // 마이크 스트림 정리
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }

                //'생각중...' 표시
                answerEl.innerText = "생각중...";

                const formData = new FormData();
                formData.append('audio', audioBlob, 'record.wav');

                try{
                    const res = await fetch('/chat/process_audio/', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();

                    if (data.error) {
                        alert(data.error);
                    } else {
                        answerEl.innerText = data.answer;
                        responseAudio.src = data.audio_url;
                        responseAudio.play();

                    //재생 끝나면 자동 녹음 재시작
                        responseAudio.onended = () => {
                            startRecording();
                        };
                    }
                } catch (err) {
                    alert("서버와 통신 중 오류 발생: " + err);
                }
            };

            mediaRecorder.start();
            sendBtn.innerText = "말씀해주세요..멈추려면 다시 눌러주세요";

            // ✅ 6초 후 자동 종료
            autoStopTimer = setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                    sendBtn.innerText = "버튼을 눌러 말씀해주세요";
                }
            }, 6000);
        } catch (err) {
            alert("마이크 접근 실패: " + err);
        }
    }

    sendBtn.addEventListener('click', () => {
        if (!autoRecord) {
            autoRecord = true; // 다시 녹음 가능하게 설정
        }

        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            startRecording();
        } else if (mediaRecorder.state === "recording") {
            if (autoStopTimer) {
                clearTimeout(autoStopTimer);
                autoStopTimer = null;
            }
            mediaRecorder.stop();
            sendBtn.innerText = "버튼을 눌러 말씀해주세요";
        }
    });

    // ✅ 종료 버튼
    endBtn.addEventListener('click', async () => {
        autoRecord = false; // 자동 녹음 비활성화

        // 타이머 제거
        if (autoStopTimer) {
            clearTimeout(autoStopTimer);
            autoStopTimer = null;
        }

        // 현재 녹음 중이면 즉시 중지
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        }

        // 마이크 스트림 정리
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }

        try {
            const res = await fetch('/chat/end_chat/', { method: 'POST' });
            const data = await res.json();
            if (data.status === "chat_ended") {
                answerEl.innerText = "대화가 종료되었습니다.";
                responseAudio.src = "";
                sendBtn.innerText = "버튼을 눌러 말씀해주세요";
            }
        } catch (err) {
            alert("대화 종료 실패: " + err);
        }
    });
    </script>
</body>
</html>
