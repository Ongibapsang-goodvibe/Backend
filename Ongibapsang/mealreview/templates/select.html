<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì„¸ë¶€ ì„ íƒ</title>
<style>
  body{margin:0;background:#111;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;display:flex;justify-content:center}
  .phone{width:360px;min-height:640px;background:#1c1c1c;border-radius:20px;padding:18px;margin:24px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
  h1{font-size:22px;margin:8px 0 18px}
  .small{font-size:13px;color:#9aa0a6;margin-top:2px}
  .btn{width:100%;padding:14px 16px;margin:8px 0;border-radius:12px;border:1px solid #444;background:#2a2a2a;color:#eee;font-size:16px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn-voice{background:#fff;color:#111;display:flex;align-items:center;justify-content:center;gap:8px}
  .btn.selected{outline:2px solid #ffb44c;background:#2f2f2f}
  .btn.primary{background:#ffb44c;color:#000;border:0;font-weight:700}
  .row{display:flex;gap:10px;margin-top:10px}
  .row .btn{flex:1}
</style>
</head>
<body>
<div class="phone">
  <div id="breadcrumb" class="small"></div>
  <h1 id="title">ì„¸ë¶€ ì„ íƒ</h1>

  <!-- ì˜µì…˜ ë²„íŠ¼ë“¤ -->
  <div id="option-list"></div>

  <!-- ìŒì„± í˜ì´ì§€ë¡œ ì´ë™ -->
  <div id="voice-btn" class="btn btn-voice" role="button">ğŸ™ï¸ ë§ë¡œ í• ê²Œìš”</div>

  <div class="row">
    <button id="back" class="btn">ëŒì•„ê°€ê¸°</button>
    <button id="submit" class="btn primary" disabled>ì„ íƒì™„ë£Œ</button>
  </div>

  <div id="status" class="small"></div>
</div>

<script>
/* ===== ê³µí†µ ì„¤ì • ===== */
const API_BASE = "/mealreview/api"; // urls.py ë„¤ì„ìŠ¤í˜ì´ìŠ¤
function getCookie(name){
  const v=`; ${document.cookie}`.split(`; ${name}=`);
  if(v.length===2) return v.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');

/* ===== ì´ˆê¸° íŒŒë¼ë¯¸í„°/í…ìŠ¤íŠ¸ ===== */
const params  = new URLSearchParams(location.search);
const initial = params.get('initial_label') || 'ì˜ ë¨¹ì—ˆì–´ìš”';

document.getElementById('breadcrumb').textContent = initial;
document.getElementById('title').textContent =
  (initial === 'ë³„ë¡œì˜€ì–´ìš”') ? 'ì–´ë–¤ ë¬¸ì œê°€ ìˆì—ˆë‚˜ìš”?' : 'ì–´ë–¤ ì ì´ ì¢‹ì•˜ë‚˜ìš”?';

/* ===== ìƒíƒœ ===== */
let selected = { id: null, label: "" };

/* ===== ì˜µì…˜ ë¡œë“œ (ì—†ìœ¼ë©´ í´ë°±) ===== */
async function loadOptions() {
  const listEl = document.getElementById('option-list');
  listEl.innerHTML = '';

  try {
    const res = await fetch(`${API_BASE}/options/detail/?initial_label=${encodeURIComponent(initial)}`);
    const data = await res.json();
    const items = (Array.isArray(data) && data.length)
      ? data
      : ((initial === 'ë³„ë¡œì˜€ì–´ìš”')
          ? ['ì§œìš”','ì‹±ê±°ì›Œìš”','ë‹¬ì•„ìš”','ëŠë¼í•´ìš”']
          : ['ì¢‹ì•„í•˜ëŠ” ìŒì‹ì´ì—ìš”','ê°„ì´ ë”± ë§ì•„ìš”','ì†ì´ í¸í•´ìš”']
        ).map(label => ({ id: null, label }));

    items.forEach(o=>{
      const b = document.createElement('button');
      b.className = 'btn option';
      b.textContent = o.label;
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.option').forEach(el=>el.classList.remove('selected'));
        b.classList.add('selected');
        selected = { id: o.id, label: o.label };
        document.getElementById('submit').disabled = false;
        document.getElementById('status').textContent = '';
      });
      listEl.appendChild(b);
    });
  } catch (e) {
    const fallback = (initial === 'ë³„ë¡œì˜€ì–´ìš”')
      ? ['ì§œìš”','ì‹±ê±°ì›Œìš”','ë‹¬ì•„ìš”','ëŠë¼í•´ìš”']
      : ['ì¢‹ì•„í•˜ëŠ” ìŒì‹ì´ì—ìš”','ê°„ì´ ë”± ë§ì•„ìš”','ì†ì´ í¸í•´ìš”'];
    fallback.forEach(label=>{
      const b = document.createElement('button');
      b.className = 'btn option';
      b.textContent = label;
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.option').forEach(el=>el.classList.remove('selected'));
        b.classList.add('selected');
        selected = { id: null, label };
        document.getElementById('submit').disabled = false;
        document.getElementById('status').textContent = '';
      });
      document.getElementById('option-list').appendChild(b);
    });
  }
}
loadOptions();

/* ===== ì €ì¥(ì„ íƒì™„ë£Œ) ===== */
async function saveButtonAnswer(){
  if(!selected.label){
    document.getElementById('status').textContent = 'ë²„íŠ¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.';
    return;
  }
  const payload = {
    initial_label: initial,
    source: 'BUTTON',
    option: selected.id,
    option_label: selected.label
  };

  try{
    const res = await fetch('/mealreview/logs/', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrftoken || '' },
      credentials: 'include',
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text();  // â† ì—ëŸ¬ ë³¸ë¬¸ í‘œì‹œ
      document.getElementById('status').textContent =
        `ì €ì¥ ì‹¤íŒ¨ (${res.status}): ${text}`;
      return;
    }
    location.href = '/mealreview/ui/overall/';
  }catch(e){
    document.getElementById('status').textContent = `ì €ì¥ ì‹¤íŒ¨: ${String(e)}`;
  }
}


document.getElementById('submit').addEventListener('click', saveButtonAnswer);

/* ===== ìŒì„± í˜ì´ì§€ë¡œ ì´ë™ (ì €ì¥ì€ ê±°ê¸°ì„œ) ===== */
document.getElementById('voice-btn').addEventListener('click', ()=>{
  location.href = `/mealreview/ui/voice/?initial_label=${encodeURIComponent(initial)}`;
});

/* ===== ë’¤ë¡œê°€ê¸° ===== */
document.getElementById('back').onclick = ()=>history.back();
</script>
</body>
</html>
